<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asset Camera OCR</title>

<!-- OCR Library -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
  body { margin:0; font-family: Arial, sans-serif; background:#000; }
  video { width:100vw; height:100vh; object-fit:cover; }
  #overlay {
    position:fixed;
    bottom:0;
    width:100%;
    background:rgba(0,0,0,0.78);
    color:#00ff88;
    padding:12px;
    font-size:16px;
    max-height:45%;
    overflow:auto;
    box-sizing:border-box;
  }
  #status {
    position:fixed;
    top:0;
    width:100%;
    background:rgba(0,0,0,0.6);
    color:#fff;
    padding:6px 10px;
    font-size:14px;
    box-sizing:border-box;
  }
</style>
</head>

<body>

<div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‚Ä¶</div>
<video id="video" autoplay playsinline></video>
<div id="overlay">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‚Ä¶</div>

<script>
const video   = document.getElementById("video");
const overlay = document.getElementById("overlay");
const status  = document.getElementById("status");

// =======================
// 1) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheet
// =======================
// üî¥ ‡∏ß‡∏≤‡∏á URL CSV ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ pub?output=csv)
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpXuB-T6npWk7MYedMvVFZCNghCnMg9Iu79j0KcMVreOMhksr6pLmOGpdGwfftRzRUMJGnPtr0H4wP/pub?gid=0&single=true&output=csv";

// ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet
// key = ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B (‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå)
// value = HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
let ASSETS = {};

// =======================
// 2) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet
// =======================
fetch(SHEET_URL)
  .then(res => res.text())
  .then(csv => {
    const rows = csv.split("\n").slice(1); // ‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    rows.forEach(r => {
      // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ (‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
      const c = r.split(",");

      const code = (c[1] || "").trim(); // üîë ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B = ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå

      if (code) {
        ASSETS[code] = `
          <b>‡∏£‡∏´‡∏±‡∏™:</b> ${code}<br>
          <b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${c[3] || "-"}<br>
          <b>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠:</b> ${c[5] || "-"}<br>
          <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ú‡∏•‡∏¥‡∏ï:</b> ${c[6] || "-"}<br>
          <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤:</b> ${c[7] || "-"}<br>
          <b>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤:</b> ${c[8] || "-"} ‡∏ö‡∏≤‡∏ó<br>
          <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${c[11] || "-"}
        `;
      }
    });
    status.innerText = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
  })
  .catch(err => {
    status.innerText = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    console.error(err);
  });

// =======================
// 3) ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
// =======================
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" }
}).then(stream => {
  video.srcObject = stream;
  status.innerText = "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
}).catch(err => {
  status.innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ";
  console.error(err);
});

// =======================
// 4) OCR ‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
// =======================
setInterval(async () => {
  if (video.videoWidth === 0) return;

  const canvas = document.createElement("canvas");
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);

  try {
    const ocr = await Tesseract.recognize(canvas, "eng");
    const rawText = ocr.data.text || "";

    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà OCR ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ (‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug)
    overlay.innerHTML = "OCR ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ:<br>" + rawText;

    // ‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    const cleanText = rawText.replace(/[^0-9]/g, "");

    // ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B
    Object.keys(ASSETS).forEach(code => {
      const cleanCode = code.replace(/[^0-9]/g, "");
      if (cleanCode && cleanText.includes(cleanCode)) {
        overlay.innerHTML = "‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•<br>" + ASSETS[code];
      }
    });

  } catch (e) {
    console.error(e);
  }

}, 2000);
</script>

</body>
</html>
