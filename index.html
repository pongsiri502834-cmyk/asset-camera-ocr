<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asset Camera Scanner</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body { margin:0; background:#000; font-family:Arial,sans-serif; }
video { width:100vw; height:100vh; object-fit:cover; }

#status {
  position:fixed; top:0; width:100%;
  background:rgba(0,0,0,.7); color:#fff;
  padding:6px 10px; font-size:14px;
  z-index:10;
}

#overlay {
  position:fixed; bottom:0; width:100%;
  background:rgba(0,0,0,.8); color:#00ff88;
  padding:12px; font-size:16px;
  max-height:45%; overflow:auto;
  z-index:10;
}

#startBtn {
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  font-size:20px;
  padding:14px 26px;
  z-index:20;
}

#box {
  position:fixed;
  border:2px solid #00ff88;
  display:none;
  z-index:9;
}
</style>
</head>

<body>

<div id="status">กำลังเตรียมกล้อง…</div>
<button id="startBtn">เริ่มสแกน</button>
<video id="video" autoplay playsinline></video>
<div id="box"></div>
<div id="overlay">ยังไม่เริ่มสแกน</div>

<script>
const video   = document.getElementById("video");
const status  = document.getElementById("status");
const overlay = document.getElementById("overlay");
const startBtn= document.getElementById("startBtn");
const box     = document.getElementById("box");

let armed = false;
let locked = false;

// =======================
// Google Sheet (CSV)
// =======================
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQpXuB-T6npWk7MYedMvVFZCNghCnMg9Iu79j0KcMVreOMhksr6pLmOGpdGwfftRzRUMJGnPtr0H4wP/pub?gid=0&single=true&output=csv";

let ASSETS = {};

// โหลดข้อมูล
fetch(SHEET_URL)
.then(r=>r.text())
.then(csv=>{
  csv.split("\n").slice(1).forEach(r=>{
    const c = r.split(",");
    const code = (c[1]||"").trim();
    if(code){
      ASSETS[code.replace(/\D/g,"")] = `
        <b>รหัส:</b> ${code}<br>
        <b>รายละเอียด:</b> ${c[3]||"-"}<br>
        <b>ยี่ห้อ:</b> ${c[5]||"-"}<br>
        <b>หมายเลข:</b> ${c[6]||"-"}<br>
        <b>มูลค่า:</b> ${c[8]||"-"} บาท<br>
        <b>สถานะ:</b> ${c[11]||"-"}
      `;
    }
  });
  status.innerText = "โหลดข้อมูลแล้ว | กดเริ่มสแกน";
});

// =======================
// เปิดกล้อง
// =======================
navigator.mediaDevices.getUserMedia({
  video:{ facingMode:"environment" }
}).then(s=>{
  video.srcObject=s;
  status.innerText="กล้องพร้อมใช้งาน";
});

// =======================
// ปุ่มเริ่มสแกน
// =======================
startBtn.onclick=()=>{
  armed=true;
  startBtn.style.display="none";
  overlay.innerText="แตะป้ายสินทรัพย์เพื่ออ่าน";
};

// =======================
// แตะเพื่ออ่าน
// =======================
video.addEventListener("click", async(e)=>{
  if(!armed || locked) return;

  const canvas=document.createElement("canvas");
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);

  // ---------- 1) QR Code ----------
  if("BarcodeDetector" in window){
    try{
      const det=new BarcodeDetector({formats:["qr_code"]});
      const codes=await det.detect(canvas);
      if(codes.length){
        found(codes[0].rawValue, null);
        return;
      }
    }catch{}
  }

  // ---------- 2) OCR ----------
  const ocr=await Tesseract.recognize(canvas,"eng",{
    tessedit_char_whitelist:"0123456789",
    classify_bln_numeric_mode:1
  });

  const text=ocr.data.text||"";
  const match=text.match(/\d{8,}/g);   // ≥ 8 ตัวเรียงกัน
  overlay.innerHTML="OCR อ่านได้:<br>"+text;

  if(match){
    found(match[0], ocr.data.words);
  }
});

// =======================
// เมื่อพบข้อมูล
// =======================
function found(code, words){
  locked=true;

  // แสดงกรอบ
  if(words){
    const w=words.find(v=>v.text.replace(/\D/g,"").includes(code));
    if(w){
      box.style.display="block";
      box.style.left=w.bbox.x0+"px";
      box.style.top=w.bbox.y0+"px";
      box.style.width=(w.bbox.x1-w.bbox.x0)+"px";
      box.style.height=(w.bbox.y1-w.bbox.y0)+"px";
    }
  }

  const clean=code.replace(/\D/g,"");
  overlay.innerHTML =
    "✅ พบเลขสินทรัพย์<br><b>"+clean+"</b><br><br>"+
    (ASSETS[clean]||"❌ ไม่พบในฐานข้อมูล");
}
</script>

</body>
</html>
