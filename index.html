<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asset Camera Scanner</title>

<!-- Tesseract.js v5 -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<!-- PapaParse ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö parse CSV -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root { --accent: #00ff88; }
  body { margin:0; font-family: Arial, system-ui, sans-serif; background:#000; color:#fff; }
  video { width:100vw; height:100vh; object-fit:cover; display:block; }

  #status {
    position:fixed; top:0; left:0; right:0; z-index:10;
    background:rgba(0,0,0,.7); color:#fff; padding:8px 12px; font-size:14px;
  }

  #overlay {
    position:fixed; bottom:0; left:0; right:0; z-index:10;
    background:rgba(0,0,0,.85); color:var(--accent);
    padding:10px; font-size:15px; max-height:45%; overflow:auto;
  }

  #toolbar {
    position:fixed; top:44px; right:10px; z-index:11; display:flex; gap:8px; flex-wrap:wrap;
  }
  .btn {
    background:rgba(0,0,0,.6); color:#fff; border:1px solid var(--accent);
    border-radius:6px; padding:6px 10px; font-size:14px; cursor:pointer;
  }
  .btn:disabled { opacity:.5; cursor:not-allowed; }

  /* ROI (‡∏Å‡∏£‡∏≠‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡πá‡∏á) */
  .roi { position:fixed; inset:0; pointer-events:none; z-index:5; }
  .roi::before{
    content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:60vw; height:30vh; border:2px dashed rgba(0,255,136,.9);
    box-shadow:0 0 0 9999px rgba(0,0,0,.35) inset, 0 0 12px rgba(0,255,136,.5);
    border-radius:8px;
  }

  .small{ color:#ccc; font-size:12px; }
  .hr { height:1px; border:0; background:rgba(255,255,255,.1); margin:8px 0; }
  ul.asset-list { margin:6px 0 0 18px; padding:0; }
  ul.asset-list li { margin-bottom:10px; }
</style>
</head>

<body>
  <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>

  <div id="toolbar">
    <button id="btnToggleTorch" class="btn" disabled>üî¶ ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏â‡∏≤‡∏¢</button>
    <button id="btnUnlock" class="btn" disabled>üîÅ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
  </div>

  <div class="roi" aria-hidden="true"></div>
  <video id="video" autoplay playsinline></video>
  <div id="overlay">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‚Ä¶</div>

  <!-- ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏¥‡πä‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏ö -->
  <audio id="ding" preload="auto">
    <source src="https://cdn.jsdelivr.net/gh/naptha/tesseract.js@master/docs/examples/data/confirm.mp3" type="audio/mpeg">
  </audio>

<script>
/* ==============================
   DOM refs
   ============================== */
const video   = document.getElementById("video");
const overlay = document.getElementById("overlay");
const statusEl  = document.getElementById("status");
const btnUnlock = document.getElementById("btnUnlock");
const btnToggleTorch = document.getElementById("btnToggleTorch");
const ding = document.getElementById("ding");

/* ==============================
   1) Google Sheet (CSV)
   ============================== */
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpXuB-T6npWk7MYedMvVFZCNghCnMg9Iu79j0KcMVreOMhksr6pLmOGpdGwfftRzRUMJGnPtr0H4wP/pub?gid=0&single=true&output=csv";

/* ‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏ï‡∏≤‡∏° "‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô" (8‚Äì9 ‡∏´‡∏•‡∏±‡∏Å) */
const ASSETS_BASE = new Map(); // key: baseNumber, value: Array<Asset>

/* ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
function makeAsset(row) {
  return {
    codeFull: (row.codeFull ?? "-"), // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B (‡πÅ‡∏™‡∏î‡∏á)
    detail:   (row.detail   ?? "-"), // ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° (D)
    price:    (row.price    ?? "-"), // ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤" (I)
    book:     (row.book     ?? "-"), // "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" (J)
    keeper:   (row.keeper   ?? "-"), // ‡πÄ‡∏û‡∏¥‡πà‡∏° K: ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á
    colN:     (row.colN     ?? "-")  // ‡πÄ‡∏û‡∏¥‡πà‡∏° N: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå N
    // **‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å**: ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤, ‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  };
}

/* ==============================
   Utils
   ============================== */
function escapeHTML(str) {
  return (str ?? "").toString()
    .replace(/&/g, "&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

/** ‡∏î‡∏∂‡∏á "‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô" 8‚Äì9 ‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡∏ï‡∏£‡∏¥‡∏á‡πÉ‡∏î‡πÜ */
function normalizeBase(str) {
  const s = (str ?? "").toString();
  const m = s.match(/\d{8,9}/);
  return m ? m[0] : "";
}

function assetToHTML(a) {
  return `
    <b>‡∏£‡∏´‡∏±‡∏™:</b> ${escapeHTML(a.codeFull)}<br>
    <b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${escapeHTML(a.detail)}<br>
    <b>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤:</b> ${escapeHTML(a.price)} ‡∏ö‡∏≤‡∏ó<br>
    <b>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</b> ${escapeHTML(a.book)} ‡∏ö‡∏≤‡∏ó<br>
    <b>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå K):</b> ${escapeHTML(a.keeper)}<br>
    <b>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå N:</b> ${escapeHTML(a.colN)}
  `;
}

/* ==============================
   2) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet
   ============================== */
async function loadSheet() {
  try {
    const res = await fetch(SHEET_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();

    const parsed = Papa.parse(text, { header: false, skipEmptyLines: true });

    // ‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (index 0)
    for (let i = 1; i < parsed.data.length; i++) {
      const c = parsed.data[i];

      const codeFull = ((c[1] ?? "") + "").trim();          // B
      const base     = normalizeBase(codeFull);              // ‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å B
      if (!base) continue;

      const data = makeAsset({
        codeFull: codeFull,                  // B
        detail:   (c[3]  ?? "").toString().trim(), // D
        price:    (c[8]  ?? "").toString().trim(), // I: ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤
        book:     (c[9]  ?? "").toString().trim(), // J: ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
        keeper:   (c[10] ?? "").toString().trim(), // K: ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á
        colN:     (c[13] ?? "").toString().trim()  // N: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠
      });

      if (!ASSETS_BASE.has(base)) ASSETS_BASE.set(base, []);
      ASSETS_BASE.get(base).push(data);
    }

    statusEl.innerText = `‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Ä¢ ‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${ASSETS_BASE.size.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  } catch (e) {
    console.error(e);
    statusEl.innerText = "‡πÇ‡∏´‡∏•‡∏î Google Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  }
}

/* ==============================
   3) ‡∏Å‡∏•‡πâ‡∏≠‡∏á & ‡πÑ‡∏ü‡∏â‡∏≤‡∏¢
   ============================== */
let track = null; let torchOn = false;

async function initCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" }, width: { ideal: 1920 }, height: { ideal: 1080 } },
      audio: false
    });
    video.srcObject = stream;
    statusEl.innerText = "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
    track = stream.getVideoTracks()[0];

    try {
      const caps = track.getCapabilities?.() || {};
      if ("torch" in caps) btnToggleTorch.disabled = false;
    } catch {}
  } catch (err) {
    console.error(err);
    statusEl.innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + (err.message || err);
  }
}
btnToggleTorch.addEventListener("click", async () => {
  if (!track) return;
  try {
    const caps = track.getCapabilities?.() || {};
    if (!("torch" in caps)) return;
    torchOn = !torchOn;
    await track.applyConstraints({ advanced: [{ torch: torchOn }] });
    btnToggleTorch.textContent = torchOn ? "üî¶ ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏â‡∏≤‡∏¢" : "üî¶ ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏â‡∏≤‡∏¢";
  } catch (e) { console.warn("Torch error:", e); }
});

/* ==============================
   4) Tesseract Worker
   ============================== */
let worker; let workerReady = false;
async function initOcr() {
  worker = await Tesseract.createWorker("eng", 1, { logger: () => {} });
  await worker.setParameters({
    tessedit_char_whitelist: "0123456789",
    classify_bln_numeric_mode: "1"
  });
  workerReady = true;
}

/* ==============================
   5) ‡∏ß‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ROI + debounce
   ============================== */
let locked = false; let lastRun = 0;
const SCAN_INTERVAL_MS = 1200;

function getRoiCanvas() {
  const vw = video.videoWidth, vh = video.videoHeight;
  if (!vw || !vh) return null;

  const roiW = Math.floor(vw * 0.60);
  const roiH = Math.floor(vh * 0.30);
  const roiX = Math.floor((vw - roiW) / 2);
  const roiY = Math.floor((vh - roiH) / 2);

  const canvas = document.createElement("canvas");
  canvas.width = roiW; canvas.height = roiH;

  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;
  ctx.drawImage(video, roiX, roiY, roiW, roiH, 0, 0, roiW, roiH);

  const img = ctx.getImageData(0, 0, roiW, roiH);
  const d = img.data;
  for (let i = 0; i < d.length; i += 4) {
    const gray = (d[i] * 0.299 + d[i+1] * 0.587 + d[i+2] * 0.114) | 0;
    const v = Math.max(0, Math.min(255, (gray - 128) * 1.2 + 128));
    d[i] = d[i+1] = d[i+2] = v;
  }
  ctx.putImageData(img, 0, 0);
  return canvas;
}

async function loopScan() {
  const now = Date.now();
  if (!workerReady || locked) return;
  if (now - lastRun < SCAN_INTERVAL_MS) return;
  if (video.readyState < 2 || video.videoWidth === 0) return;

  lastRun = now;

  const canvas = getRoiCanvas();
  if (!canvas) return;

  try {
    const { data } = await worker.recognize(canvas);
    const raw = (data.text || "").replace(/\s+/g, " ").trim();

    overlay.innerHTML = `OCR ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ:<br><span class="small">${escapeHTML(raw)}</span>`;

    const base = normalizeBase(raw);
    if (base) {
      const items = ASSETS_BASE.get(base);
      if (items && items.length > 0) {
        locked = true;
        overlay.innerHTML = (items.length === 1)
          ? `‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå<br><br>${assetToHTML(items[0])}`
          : `‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô ${escapeHTML(base)}
             <div class="hr"></div>
             <ul class="asset-list">${items.map(a => `<li>${assetToHTML(a)}</li>`).join("")}</ul>`;

        try { navigator.vibrate?.(120); } catch {}
        try { ding.currentTime = 0; ding.play().catch(()=>{}); } catch {}
        btnUnlock.disabled = false;
      } else {
        overlay.innerHTML = `‚ö†Ô∏è ‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô ${escapeHTML(base)}<br>‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`;
      }
    }
  } catch (e) {
    console.error("OCR error:", e);
  }
}

btnUnlock.addEventListener("click", () => {
  locked = false; btnUnlock.disabled = true; overlay.innerHTML = "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‚Ä¶";
});

setInterval(loopScan, 200);

/* ==============================
   ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
   ============================== */
(async function main() {
  await loadSheet();
  await initCamera();
  await initOcr();
  statusEl.innerText += " ‚Ä¢ OCR ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
})();
</script>
</body>
</html>
