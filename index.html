<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Camera OCR</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
  body {
    margin:0;
    background:#000;
    font-family: Arial, sans-serif;
  }
  video {
    width:100vw;
    height:100vh;
    object-fit:cover;
  }
  #status {
    position:fixed;
    top:0;
    width:100%;
    background:rgba(0,0,0,0.6);
    color:#fff;
    padding:6px 10px;
    font-size:14px;
    z-index:10;
  }
  #overlay {
    position:fixed;
    bottom:0;
    width:100%;
    background:rgba(0,0,0,0.78);
    color:#00ff88;
    padding:12px;
    font-size:16px;
    max-height:45%;
    overflow:auto;
    box-sizing:border-box;
    z-index:10;
  }
</style>
</head>

<body>

<div id="status">กำลังเริ่มต้น…</div>
<video id="video" autoplay playsinline></video>
<div id="overlay">รอการอ่านจากกล้อง…</div>

<script>
const video   = document.getElementById("video");
const overlay = document.getElementById("overlay");
const status  = document.getElementById("status");

/* =========================
   1) ตั้งค่า Google Sheet
   ========================= */
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQpXuB-T6npWk7MYedMvVFZCNghCnMg9Iu79j0KcMVreOMhksr6pLmOGpdGwfftRzRUMJGnPtr0H4wP/pub?gid=0&single=true&output=csv";

let ASSETS = {};

/* =========================
   2) โหลดข้อมูลจาก Sheet
   ========================= */
fetch(SHEET_URL)
  .then(res => res.text())
  .then(csv => {
    const rows = csv.split("\n").slice(1);
    rows.forEach(r => {
      const c = r.split(",");
      const code = (c[1] || "").trim(); // คอลัมน์ B

      if (code) {
        ASSETS[code] = `
          <b>รหัส:</b> ${code}<br>
          <b>รายละเอียด:</b> ${c[3] || "-"}<br>
          <b>ยี่ห้อ:</b> ${c[5] || "-"}<br>
          <b>หมายเลขผลิต:</b> ${c[6] || "-"}<br>
          <b>วันที่ได้มา:</b> ${c[7] || "-"}<br>
          <b>มูลค่า:</b> ${c[8] || "-"} บาท<br>
          <b>สถานะ:</b> ${c[11] || "-"}
        `;
      }
    });
    status.innerText = "โหลดข้อมูลจาก Google Sheet เรียบร้อย";
  })
  .catch(err => {
    status.innerText = "โหลดข้อมูลจาก Google Sheet ไม่สำเร็จ";
    console.error(err);
  });

/* =========================
   3) เปิดกล้องหลัง
   ========================= */
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" }
}).then(stream => {
  video.srcObject = stream;
  status.innerText = "กล้องพร้อมใช้งาน";
}).catch(err => {
  status.innerText = "ไม่สามารถเปิดกล้องได้";
  console.error(err);
});

/* =========================
   ฟังก์ชัน match แบบยืดหยุ่น
   ========================= */
function findAsset(cleanText) {
  for (const key in ASSETS) {
    const cleanKey = key.replace(/[^0-9]/g, "");
    if (
      cleanText.includes(cleanKey) ||
      cleanText.includes(cleanKey.slice(-6)) ||
      cleanKey.includes(cleanText)
    ) {
      return ASSETS[key];
    }
  }
  return null;
}

/* =========================
   4) OCR ทุก 2 วินาที
   ========================= */
setInterval(async () => {
  if (video.videoWidth === 0) return;

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  const w = video.videoWidth;
  const h = video.videoHeight;

  // crop เฉพาะกลางภาพ (ป้าย)
  const cropW = w * 0.6;
  const cropH = h * 0.3;
  const sx = (w - cropW) / 2;
  const sy = (h - cropH) / 2;

  canvas.width = cropW;
  canvas.height = cropH;
  ctx.drawImage(video, sx, sy, cropW, cropH, 0, 0, cropW, cropH);

  try {
    const ocr = await Tesseract.recognize(canvas, "eng", {
      tessedit_char_whitelist: "0123456789-",
      classify_bln_numeric_mode: 1
    });

    const rawText = ocr.data.text || "";
    overlay.innerHTML = "OCR อ่านได้:<br>" + rawText;

    const cleanText = rawText.replace(/[^0-9]/g, "");

    const found = findAsset(cleanText);
    if (found) {
      overlay.innerHTML = "✅ พบข้อมูล<br>" + found;
    }

  } catch (e) {
    console.error(e);
  }
}, 2000);
</script>

</body>
</html>
