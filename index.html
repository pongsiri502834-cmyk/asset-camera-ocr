<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asset Camera OCR</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
  body { margin:0; background:#000; font-family:Arial; }
  video { width:100vw; height:100vh; object-fit:cover; }
  canvas { display:none; }

  #roi {
    position:fixed;
    border:2px solid #00ff88;
    pointer-events:none;
  }

  #status {
    position:fixed; top:0; width:100%;
    background:rgba(0,0,0,.65);
    color:#fff; padding:6px 10px;
    font-size:14px;
  }

  #overlay {
    position:fixed; bottom:0; width:100%;
    background:rgba(0,0,0,.8);
    color:#00ff88; padding:12px;
    font-size:16px; max-height:45%;
    overflow:auto;
  }
</style>
</head>

<body>

<div id="status">แตะที่เลขสินทรัพย์เพื่ออ่าน</div>
<video id="video" autoplay playsinline></video>
<div id="roi"></div>
<div id="overlay">ยังไม่เริ่ม OCR</div>

<script>
const video   = document.getElementById("video");
const overlay = document.getElementById("overlay");
const status  = document.getElementById("status");
const roiBox  = document.getElementById("roi");

const SHEET_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQpXuB-T6npWk7MYedMvVFZCNghCnMg9Iu79j0KcMVreOMhksr6pLmOGpdGwfftRzRUMJGnPtr0H4wP/pub?gid=0&single=true&output=csv";

let ASSETS = {};
let roi = null;
let locked = false;

/* ================= โหลด Google Sheet ================= */
fetch(SHEET_URL)
.then(r => r.text())
.then(csv => {
  csv.split("\n").slice(1).forEach(r => {
    const c = r.split(",");
    const code = (c[1] || "").trim();
    if (code) {
      ASSETS[code.replace(/\D/g,"")] = `
        <b>รหัส:</b> ${code}<br>
        <b>รายละเอียด:</b> ${c[3] || "-"}<br>
        <b>ยี่ห้อ:</b> ${c[5] || "-"}<br>
        <b>หมายเลข:</b> ${c[6] || "-"}<br>
        <b>วันที่ได้มา:</b> ${c[7] || "-"}<br>
        <b>มูลค่า:</b> ${c[8] || "-"} บาท<br>
        <b>สถานะ:</b> ${c[11] || "-"}
      `;
    }
  });
  status.innerText = "โหลดข้อมูลแล้ว – แตะเพื่อเลือกตำแหน่ง";
});

/* ================= เปิดกล้อง ================= */
navigator.mediaDevices.getUserMedia({
  video:{ facingMode:"environment" }
}).then(s=>{
  video.srcObject = s;
});

/* ================= แตะเพื่อเลือก ROI ================= */
video.addEventListener("click", e=>{
  if (locked) return;

  const vw = video.videoWidth;
  const vh = video.videoHeight;
  const rect = video.getBoundingClientRect();

  const x = (e.clientX - rect.left) / rect.width * vw;
  const y = (e.clientY - rect.top)  / rect.height * vh;

  roi = {
    x: Math.max(x - 200, 0),
    y: Math.max(y - 60, 0),
    w: 400,
    h: 120
  };

  roiBox.style.left = `${e.clientX-200}px`;
  roiBox.style.top  = `${e.clientY-60}px`;
  roiBox.style.width  = "400px";
  roiBox.style.height = "120px";

  status.innerText = "กำลังอ่านเลขในกรอบ…";
});

/* ================= OCR Loop ================= */
setInterval(async ()=>{
  if (!roi || locked || video.videoWidth === 0) return;

  const c = document.createElement("canvas");
  c.width = roi.w;
  c.height = roi.h;
  const ctx = c.getContext("2d");

  ctx.drawImage(
    video,
    roi.x, roi.y, roi.w, roi.h,
    0, 0, roi.w, roi.h
  );

  const ocr = await Tesseract.recognize(c, "eng", {
    tessedit_char_whitelist:"0123456789",
    classify_bln_numeric_mode:1
  });

  const raw = ocr.data.text || "";
  const clean = raw.replace(/\D/g,"");

  overlay.innerHTML =
    "OCR อ่านได้:<br>" + raw +
    "<br><br>Clean:<br>" + clean;

  if (ASSETS[clean]) {
    locked = true;
    overlay.innerHTML = "✅ พบข้อมูลแล้ว<br><br>" + ASSETS[clean];
    status.innerText = "ล็อกผลแล้ว";
    roiBox.style.border = "3px solid red";
  }

}, 1200);
</script>

</body>
</html>
