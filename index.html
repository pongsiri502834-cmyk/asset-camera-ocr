<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Camera OCR</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #000;
    overflow: hidden;
  }
  video {
    width: 100vw;
    height: 100vh;
    object-fit: cover;
  }
  #status {
    position: fixed;
    top: 0;
    width: 100%;
    padding: 6px 10px;
    background: rgba(0,0,0,0.65);
    color: #fff;
    font-size: 14px;
    z-index: 10;
  }
  #overlay {
    position: fixed;
    bottom: 0;
    width: 100%;
    max-height: 45%;
    overflow: auto;
    padding: 12px;
    background: rgba(0,0,0,0.8);
    color: #00ff88;
    font-size: 16px;
    box-sizing: border-box;
    z-index: 10;
  }
</style>
</head>

<body>

<div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‚Ä¶</div>
<video id="video" autoplay playsinline></video>
<div id="overlay">‡∏£‡∏≠ OCR‚Ä¶</div>

<script>
const video   = document.getElementById("video");
const overlay = document.getElementById("overlay");
const status  = document.getElementById("status");

/* =========================
   1) Google Sheet (CSV)
   ========================= */
// ‚ùó ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô publish to web ‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ output=csv
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQpXuB-T6npWk7MYedMvVFZCNghCnMg9Iu79j0KcMVreOMhksr6pLmOGpdGwfftRzRUMJGnPtr0H4wP/pub?gid=0&single=true&output=csv";

// key = ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B (‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå)
let ASSETS = {};

/* =========================
   2) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet
   ========================= */
fetch(SHEET_URL)
  .then(r => r.text())
  .then(csv => {
    const rows = csv.split("\n").slice(1);
    rows.forEach(row => {
      const c = row.split(",");
      const code = (c[1] || "").trim(); // üîë ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B
      if (!code) return;

      ASSETS[code] = `
        <b>‡∏£‡∏´‡∏±‡∏™:</b> ${code}<br>
        <b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${c[3] || "-"}<br>
        <b>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠:</b> ${c[5] || "-"}<br>
        <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ú‡∏•‡∏¥‡∏ï:</b> ${c[6] || "-"}<br>
        <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤:</b> ${c[7] || "-"}<br>
        <b>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤:</b> ${c[8] || "-"} ‡∏ö‡∏≤‡∏ó<br>
        <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${c[11] || "-"}
      `;
    });
    status.innerText = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
  })
  .catch(err => {
    status.innerText = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    console.error(err);
  });

/* =========================
   3) ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
   ========================= */
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" }
}).then(stream => {
  video.srcObject = stream;
  status.innerText += " | ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
}).catch(err => {
  status.innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ";
  console.error(err);
});

/* =========================
   4) OCR ‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
   ========================= */
setInterval(async () => {
  if (video.videoWidth === 0) return;

  // === crop ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ ===
  const cropW = video.videoWidth * 0.6;
  const cropH = video.videoHeight * 0.25;
  const sx = (video.videoWidth - cropW) / 2;
  const sy = (video.videoHeight - cropH) / 2;

  const canvas = document.createElement("canvas");
  canvas.width = cropW;
  canvas.height = cropH;
  const ctx = canvas.getContext("2d");

  // üîÅ ‡∏´‡∏°‡∏∏‡∏ô 180¬∞ (‡πÅ‡∏Å‡πâ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏±‡∏ß)
  ctx.save();
  ctx.translate(cropW / 2, cropH / 2);
  ctx.rotate(Math.PI);
  ctx.drawImage(
    video,
    sx, sy, cropW, cropH,
    -cropW / 2, -cropH / 2,
    cropW, cropH
  );
  ctx.restore();

  try {
    const ocr = await Tesseract.recognize(
      canvas,
      "eng+tha",
      {
        tessedit_char_whitelist: "0123456789",
        preserve_interword_spaces: 1
      }
    );

    const rawText = ocr.data.text || "";
    const cleanText = rawText.replace(/[^0-9]/g, "");

    // debug
    overlay.innerHTML =
      "OCR ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ:<br>" + rawText +
      "<br><br>Clean:<br>" + cleanText;

    // match ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B
    Object.keys(ASSETS).forEach(code => {
      const cleanCode = code.replace(/[^0-9]/g, "");
      if (cleanCode && cleanText.includes(cleanCode)) {
        overlay.innerHTML = "‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•<br>" + ASSETS[code];
      }
    });

  } catch (e) {
    console.error(e);
  }

}, 2000);
</script>

</body>
</html>
