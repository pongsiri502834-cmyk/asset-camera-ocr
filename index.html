<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asset Camera Scanner</title>

<!-- Tesseract.js v5 -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<!-- PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root { --accent:#00ff88; }
  body { margin:0; font-family:Arial, system-ui, sans-serif; background:#000; color:#fff; }
  video { width:100vw; height:100vh; object-fit:cover; display:block; }

  #status { position:fixed; top:0; left:0; right:0; z-index:10;
    background:rgba(0,0,0,.7); color:#fff; padding:8px 12px; font-size:14px; }

  #overlay { position:fixed; bottom:0; left:0; right:0; z-index:10;
    background:rgba(0,0,0,.85); color:var(--accent);
    padding:10px; font-size:15px; max-height:45%; overflow:auto; }

  #toolbar { position:fixed; top:44px; right:10px; z-index:11; display:flex; gap:8px; flex-wrap:wrap; }
  .btn { background:rgba(0,0,0,.6); color:#fff; border:1px solid var(--accent);
    border-radius:6px; padding:6px 10px; font-size:14px; cursor:pointer; }
  .btn:disabled { opacity:.5; cursor:not-allowed; }

  .roi { position:fixed; inset:0; pointer-events:none; z-index:5; }
  .roi::before{
    content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:60vw; height:30vh; border:2px dashed rgba(0,255,136,.9);
    box-shadow:0 0 0 9999px rgba(0,0,0,.35) inset, 0 0 12px rgba(0,255,136,.5);
    border-radius:8px;
  }

  .small{ color:#ccc; font-size:12px; }
  .hr { height:1px; border:0; background:rgba(255,255,255,.1); margin:8px 0; }
  ul.asset-list { margin:6px 0 0 18px; padding:0; }
  ul.asset-list li { margin-bottom:10px; }
</style>
</head>

<body>
  <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>

  <div id="toolbar">
    <button id="btnToggleTorch" class="btn" disabled>üî¶ ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏â‡∏≤‡∏¢</button>
    <button id="btnUnlock" class="btn" disabled>üîÅ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
  </div>

  <div class="roi" aria-hidden="true"></div>
  <video id="video" autoplay playsinline></video>
  <div id="overlay">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‚Ä¶</div>

  <audio id="ding" preload="auto">
    <source src="https://cdn.jsdelivr.net/gh/naptha/tesseract.js@master/docs/examples/data/confirm.mp3" type="audio/mpeg">
  </audio>

<script>
/* ==============================
   CONFIG
   ============================== */
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpXuB-T6npWk7MYedMvVFZCNghCnMg9Iu79j0KcMVreOMhksr6pLmOGpdGwfftRzRUMJGnPtr0H4wP/pub?gid=0&single=true&output=csv";

/** ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‚Äú‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‚Äù ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î */
const HEADERS_SYNONYMS = {
  CODE:   ["‡∏£‡∏´‡∏±‡∏™", "‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå", "‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå", "‡πÄ‡∏•‡∏Ç‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå"],
  DETAIL: ["‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢"],
  PRICE:  ["‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô", "‡∏£‡∏≤‡∏Ñ‡∏≤", "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°"],
  BOOK:   ["‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ", "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥", "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠", "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤(‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)"],
  KEEPER: ["‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á", "‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á", "‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á", "‡∏ú‡∏π‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á", "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"],
  STATUS: ["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"]
};

/** ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á ‚Äú‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‚Äù ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á) ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ
 *   ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô Fallback ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏≤ header ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
 *   ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ B,D,I,K,N,L ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
 */
const FALLBACK_COL_LETTER = {
  CODE: 'B',
  DETAIL: 'D',
  PRICE: 'I',
  BOOK: 'N',
  KEEPER: 'K',
  STATUS: 'L'
};

/** Debug: ‡πÄ‡∏õ‡∏¥‡∏î true ‡∏à‡∏∞ log ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πá‡∏õ‡πÑ‡∏î‡πâ */
const DEBUG_LOG = true;

/* ==============================
   DOM
   ============================== */
const video   = document.getElementById("video");
const overlay = document.getElementById("overlay");
const statusEl  = document.getElementById("status");
const btnUnlock = document.getElementById("btnUnlock");
const btnToggleTorch = document.getElementById("btnToggleTorch");
const ding = document.getElementById("ding");

/* ==============================
   Utils
   ============================== */
function escapeHTML(str){
  return (str??"").toString()
   .replace(/&/g,"&amp;").replace(/</g,"&lt;")
   .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function normalizeBase(str){
  const m = ((str??"")+"").match(/\d{8,9}/);
  return m ? m[0] : "";
}
function colLetterToIndex(letter){
  const s = (letter||"").toUpperCase().trim();
  let n = 0;
  for (let i=0; i<s.length; i++){
    n = n*26 + (s.charCodeAt(i)-64);
  }
  return n-1;
}
function normalizeHeaderKey(k){
  return k.toString().replace(/\s+/g,'').replace(/[()]/g,'').toLowerCase();
}

/** ‡∏´‡∏≤ header ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å fields ‡πÇ‡∏î‡∏¢‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏û‡πâ‡∏≠‡∏á */
function resolveHeaderKey(fields, synonyms){
  const normalizedMap = {};
  fields.forEach((k)=> normalizedMap[ normalizeHeaderKey(k) ] = k);

  for(const name of synonyms){
    const want = normalizeHeaderKey(name);
    if (normalizedMap[want]) return normalizedMap[want];
  }
  return null;
}

/** ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å row ‡∏ï‡∏≤‡∏° ‚Äú‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á‚Äù ‡∏´‡∏£‡∏∑‡∏≠ fallback ‚Äú‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‚Äù */
function getValue(rowObjOrArr, fields, synonyms, fallbackLetter){
  // 1) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô object (header:true)
  if (!Array.isArray(rowObjOrArr)) {
    const headerKey = resolveHeaderKey(fields, synonyms);
    if (headerKey && rowObjOrArr[headerKey] !== undefined) {
      return rowObjOrArr[headerKey];
    }
    // fallback: ‡πÉ‡∏ä‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö fields ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    if (fallbackLetter) {
      const idx = colLetterToIndex(fallbackLetter);
      const fbKey = fields[idx];
      if (fbKey && rowObjOrArr[fbKey] !== undefined) return rowObjOrArr[fbKey];
    }
    return "";
  }

  // 2) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô array (header:false)
  const idx = colLetterToIndex(fallbackLetter || 'A');
  return (rowObjOrArr[idx] ?? "");
}

/** true ‡∏ñ‡πâ‡∏≤‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô ‚Äú‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏á‡∏¥‡∏ô‚Äù */
function looksLikeNumber(x){
  const s = (x??"").toString().trim();
  if (!s) return false;
  // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï 0-9 . , ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡πÜ
  return /^[\d.,\s]+$/.test(s);
}

/* ==============================
   Data store
   ============================== */
const ASSETS_BASE = new Map(); // key: base, value: Array<asset>

/* ==============================
   ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ï
   ============================== */
async function loadSheet(){
  try{
    const res = await fetch(SHEET_URL,{cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const text = await res.text();

    // ‡πÉ‡∏ä‡πâ header:true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    let parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    let useHeader = true;

    // ‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô header ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏Ñ‡πà‡∏≠‡∏¢ fallback header:false
    if (!parsed.data || !parsed.data.length || (parsed.meta.fields||[]).length <= 1) {
      parsed = Papa.parse(text, { header: false, skipEmptyLines: true });
      useHeader = false;
    }

    const rows = parsed.data;
    const fields = useHeader ? (parsed.meta.fields || []) : []; // ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    if (DEBUG_LOG && useHeader) {
      console.log("‚úÖ Header fields:", fields);
      console.log("üîé Matched headers:",
        {
          CODE:   resolveHeaderKey(fields, HEADERS_SYNONYMS.CODE),
          DETAIL: resolveHeaderKey(fields, HEADERS_SYNONYMS.DETAIL),
          PRICE:  resolveHeaderKey(fields, HEADERS_SYNONYMS.PRICE),
          BOOK:   resolveHeaderKey(fields, HEADERS_SYNONYMS.BOOK),
          KEEPER: resolveHeaderKey(fields, HEADERS_SYNONYMS.KEEPER),
          STATUS: resolveHeaderKey(fields, HEADERS_SYNONYMS.STATUS)
        }
      );
    }

    let count = 0;

    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];

      const codeB  = useHeader
        ? getValue(row, fields, HEADERS_SYNONYMS.CODE,   FALLBACK_COL_LETTER.CODE)
        : getValue(row, [],     [],                      FALLBACK_COL_LETTER.CODE);

      const base = normalizeBase(codeB);
      if (!base) continue;

      const detailD = useHeader
        ? getValue(row, fields, HEADERS_SYNONYMS.DETAIL, FALLBACK_COL_LETTER.DETAIL)
        : getValue(row, [],     [],                      FALLBACK_COL_LETTER.DETAIL);

      const priceI  = useHeader
        ? getValue(row, fields, HEADERS_SYNONYMS.PRICE,  FALLBACK_COL_LETTER.PRICE)
        : getValue(row, [],     [],                      FALLBACK_COL_LETTER.PRICE);

      let bookN     = useHeader
        ? getValue(row, fields, HEADERS_SYNONYMS.BOOK,   FALLBACK_COL_LETTER.BOOK)
        : getValue(row, [],     [],                      FALLBACK_COL_LETTER.BOOK);

      let keeperK   = useHeader
        ? getValue(row, fields, HEADERS_SYNONYMS.KEEPER, FALLBACK_COL_LETTER.KEEPER)
        : getValue(row, [],     [],                      FALLBACK_COL_LETTER.KEEPER);

      const statusL = useHeader
        ? getValue(row, fields, HEADERS_SYNONYMS.STATUS, FALLBACK_COL_LETTER.STATUS)
        : getValue(row, [],     [],                      FALLBACK_COL_LETTER.STATUS);

      // ---- Heuristic ‡∏Å‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ----
      const bookIsNumber   = looksLikeNumber(bookN);
      const keeperIsNumber = looksLikeNumber(keeperK);
      const bookIsText     = !bookIsNumber && /\D/.test((bookN??"").toString());
      // ‡∏ñ‡πâ‡∏≤ book ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÅ‡∏ï‡πà keeper ‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‚Äù ‚Üí ‡∏™‡∏•‡∏±‡∏ö
      if (bookIsText && keeperIsNumber) {
        const tmp = bookN; bookN = keeperK; keeperK = tmp;
      }

      const asset = {
        base,
        codeB:   (codeB   ?? "").toString().trim(),
        detailD: (detailD ?? "").toString().trim(),
        priceI:  (priceI  ?? "").toString().trim(),
        bookN:   (bookN   ?? "").toString().trim(),
        keeperK: (keeperK ?? "").toString().trim(),
        statusL: (statusL ?? "").toString().trim()
      };

      if (!ASSETS_BASE.has(base)) ASSETS_BASE.set(base, []);
      ASSETS_BASE.get(base).push(asset);
      count++;
    }

    statusEl.innerText = `‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Ä¢ ‡πÅ‡∏ñ‡∏ß: ${count.toLocaleString()} ‚Ä¢ ‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô: ${ASSETS_BASE.size.toLocaleString()}`;
  }catch(e){
    console.error(e);
    statusEl.innerText = "‡πÇ‡∏´‡∏•‡∏î Google Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  }
}

/* ==============================
   ‡∏Å‡∏•‡πâ‡∏≠‡∏á & ‡πÑ‡∏ü‡∏â‡∏≤‡∏¢
   ============================== */
let track=null, torchOn=false;
async function initCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ideal:"environment"}, width:{ideal:1920}, height:{ideal:1080} },
      audio:false
    });
    video.srcObject = stream;
    statusEl.innerText = "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
    track = stream.getVideoTracks()[0];

    try{
      const caps = track.getCapabilities?.() || {};
      if("torch" in caps) btnToggleTorch.disabled = false;
    }catch{}
  }catch(err){
    console.error(err);
    statusEl.innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + (err.message||err);
  }
}
btnToggleTorch.addEventListener("click", async ()=>{
  if(!track) return;
  try{
    const caps = track.getCapabilities?.() || {};
    if(!("torch" in caps)) return;
    torchOn = !torchOn;
    await track.applyConstraints({advanced:[{torch:torchOn}]});
    btnToggleTorch.textContent = torchOn ? "üî¶ ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏â‡∏≤‡∏¢" : "üî¶ ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏â‡∏≤‡∏¢";
  }catch(e){ console.warn("Torch error:", e); }
});

/* ==============================
   Tesseract
   ============================== */
let worker, workerReady=false;
async function initOcr(){
  worker = await Tesseract.createWorker("eng",1,{logger:()=>{}});
  await worker.setParameters({
    tessedit_char_whitelist:"0123456789",
    classify_bln_numeric_mode:"1"
  });
  workerReady = true;
}

/* ==============================
   Scan loop
   ============================== */
let locked=false, lastRun=0;
const SCAN_INTERVAL_MS = 1200;

function getRoiCanvas(){
  const vw=video.videoWidth, vh=video.videoHeight;
  if(!vw||!vh) return null;

  const roiW=Math.floor(vw*0.60), roiH=Math.floor(vh*0.30);
  const roiX=Math.floor((vw-roiW)/2), roiY=Math.floor((vh-roiH)/2);

  const canvas=document.createElement("canvas");
  canvas.width=roiW; canvas.height=roiH;

  const ctx=canvas.getContext("2d");
  ctx.imageSmoothingEnabled=false;
  ctx.drawImage(video, roiX,roiY,roiW,roiH, 0,0,roiW,roiH);

  // grayscale + contrast
  const img=ctx.getImageData(0,0,roiW,roiH); const d=img.data;
  for(let i=0;i<d.length;i+=4){
    const gray=(d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114) | 0;
    const v=Math.max(0,Math.min(255,(gray-128)*1.2+128));
    d[i]=d[i+1]=d[i+2]=v;
  }
  ctx.putImageData(img,0,0);
  return canvas;
}

function assetToHTML(a){
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
  // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏ö‡∏≤‡∏ó" ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤
  return `
    <b>‡∏£‡∏´‡∏±‡∏™:</b> ${escapeHTML(a.codeB)}<br>
    <b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${escapeHTML(a.detailD)}<br>
    <b>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤:</b> ${escapeHTML(a.priceI)} ‡∏ö‡∏≤‡∏ó<br>
    <b>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</b> ${escapeHTML(a.bookN)} ‡∏ö‡∏≤‡∏ó<br>
    <b>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á:</b> ${escapeHTML(a.keeperK)}<br>
    <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${escapeHTML(a.statusL)}
  `;
}

async function loopScan(){
  const now=Date.now();
  if(!workerReady||locked) return;
  if(now-lastRun<SCAN_INTERVAL_MS) return;
  if(video.readyState<2||video.videoWidth===0) return;

  lastRun=now;

  const canvas=getRoiCanvas();
  if(!canvas) return;

  try{
    const {data} = await worker.recognize(canvas);
    const raw=(data.text||"").replace(/\s+/g," ").trim();

    overlay.innerHTML = `OCR ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ:<br><span class="small">${escapeHTML(raw)}</span>`;

    const base = normalizeBase(raw);
    if(base){
      const items = ASSETS_BASE.get(base);
      if(items && items.length>0){
        locked=true;

        if(items.length===1){
          overlay.innerHTML = `‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå<br><br>${assetToHTML(items[0])}`;
        }else{
          const lis = items.map(a=>`<li>${assetToHTML(a)}</li>`).join("");
          overlay.innerHTML = `
            ‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå ${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô ${escapeHTML(base)}
            <div class="hr"></div>
            <ul class="asset-list">${lis}</ul>
          `;
        }

        try{navigator.vibrate?.(120);}catch{}
        try{ding.currentTime=0; ding.play().catch(()=>{});}catch{}
        btnUnlock.disabled=false;
      }else{
        overlay.innerHTML = `‚ö†Ô∏è ‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô ${escapeHTML(base)}<br>‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`;
      }
    }
  }catch(e){
    console.error("OCR error:", e);
  }
}

btnUnlock.addEventListener("click", ()=>{
  locked=false; btnUnlock.disabled=true; overlay.innerHTML="‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‚Ä¶";
});
setInterval(loopScan,200);

/* ==============================
   Start
   ============================== */
(async function main(){
  await loadSheet();
  await initCamera();
  await initOcr();
  statusEl.innerText += " ‚Ä¢ OCR ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
})();
</script>
</body>
</html>
