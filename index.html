<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Camera OCR</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #000;
    overflow: hidden;
  }
  video {
    width: 100vw;
    height: 100vh;
    object-fit: cover;
  }
  #status {
    position: fixed;
    top: 0;
    width: 100%;
    padding: 6px 10px;
    background: rgba(0,0,0,0.65);
    color: #fff;
    font-size: 14px;
    z-index: 20;
  }
  #overlay {
    position: fixed;
    bottom: 0;
    width: 100%;
    max-height: 45%;
    overflow: auto;
    padding: 12px;
    background: rgba(0,0,0,0.8);
    color: #00ff88;
    font-size: 16px;
    box-sizing: border-box;
    z-index: 20;
  }

  /* ‡∏Å‡∏£‡∏≠‡∏ö OCR */
  #scan-box {
    position: fixed;
    border: 3px solid #00ff88;
    width: 60vw;
    height: 25vh;
    left: 20vw;
    top: 37.5vh;
    box-sizing: border-box;
    z-index: 15;
  }

  #controls {
    position: fixed;
    right: 10px;
    top: 60px;
    background: rgba(0,0,0,0.7);
    padding: 10px;
    color: #fff;
    font-size: 14px;
    z-index: 20;
    border-radius: 6px;
  }

  button {
    margin-top: 6px;
    width: 100%;
    padding: 6px;
    font-size: 14px;
  }
</style>
</head>

<body>

<div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‚Ä¶</div>
<video id="video" autoplay playsinline></video>
<div id="scan-box"></div>
<div id="overlay">‡∏£‡∏≠ OCR‚Ä¶</div>

<div id="controls">
  ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß OCR<br>
  <input id="speed" type="range" min="1000" max="5000" step="500" value="2000">
  <div id="speedLabel">‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
  <button onclick="resetScan()">üîÑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
</div>

<script>
const video   = document.getElementById("video");
const overlay = document.getElementById("overlay");
const status  = document.getElementById("status");
const speed   = document.getElementById("speed");
const speedLabel = document.getElementById("speedLabel");

/* ======================
   ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°
   ====================== */
let ASSETS = {};
let locked = false;
let intervalId = null;

/* ======================
   Google Sheet
   ====================== */
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQpXuB-T6npWk7MYedMvVFZCNghCnMg9Iu79j0KcMVreOMhksr6pLmOGpdGwfftRzRUMJGnPtr0H4wP/pub?gid=0&single=true&output=csv";

/* ======================
   ‡πÇ‡∏´‡∏•‡∏î Sheet
   ====================== */
fetch(SHEET_URL)
  .then(r => r.text())
  .then(csv => {
    csv.split("\n").slice(1).forEach(r => {
      const c = r.split(",");
      const code = (c[1] || "").trim();
      if (!code) return;

      ASSETS[code] = `
        <b>‡∏£‡∏´‡∏±‡∏™:</b> ${code}<br>
        <b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${c[3] || "-"}<br>
        <b>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠:</b> ${c[5] || "-"}<br>
        <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ú‡∏•‡∏¥‡∏ï:</b> ${c[6] || "-"}<br>
        <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤:</b> ${c[7] || "-"}<br>
        <b>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤:</b> ${c[8] || "-"} ‡∏ö‡∏≤‡∏ó<br>
        <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${c[11] || "-"}
      `;
    });
    status.innerText = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
  });

/* ======================
   ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
   ====================== */
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" }
}).then(stream => {
  video.srcObject = stream;
  status.innerText += " | ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
});

/* ======================
   OCR Loop
   ====================== */
function startOCR() {
  clearInterval(intervalId);
  intervalId = setInterval(scanFrame, speed.value);
}

async function scanFrame() {
  if (locked || video.videoWidth === 0) return;

  const cw = video.videoWidth * 0.6;
  const ch = video.videoHeight * 0.25;
  const sx = (video.videoWidth - cw) / 2;
  const sy = (video.videoHeight - ch) / 2;

  const canvas = document.createElement("canvas");
  canvas.width = cw;
  canvas.height = ch;
  const ctx = canvas.getContext("2d");

  // ‡∏´‡∏°‡∏∏‡∏ô 180¬∞ (‡πÅ‡∏Å‡πâ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏±‡∏ß)
  ctx.translate(cw / 2, ch / 2);
  ctx.rotate(Math.PI);
  ctx.drawImage(video, sx, sy, cw, ch, -cw/2, -ch/2, cw, ch);

  const ocr = await Tesseract.recognize(canvas, "eng+tha", {
    tessedit_char_whitelist: "0123456789",
  });

  const raw = ocr.data.text || "";
  const clean = raw.replace(/[^0-9]/g, "");

  overlay.innerHTML = "OCR:<br>" + raw;

  Object.keys(ASSETS).forEach(code => {
    const c = code.replace(/[^0-9]/g, "");
    if (clean.includes(c)) {
      locked = true;
      overlay.innerHTML = "‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•<br>" + ASSETS[code];
      status.innerText = "‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß (‡∏•‡πá‡∏≠‡∏Å)";
    }
  });
}

/* ======================
   ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°
   ====================== */
speed.oninput = () => {
  speedLabel.innerText = `‡∏ó‡∏∏‡∏Å ${speed.value / 1000} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
  startOCR();
};

function resetScan() {
  locked = false;
  overlay.innerText = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà‚Ä¶";
  status.innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô";
}

startOCR();
</script>

</body>
</html>
