<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asset Camera Scanner</title>

<!-- Tesseract.js v5 -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<!-- PapaParse ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö parse CSV -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root { --accent:#00ff88; }
  body { margin:0; font-family:Arial, system-ui, sans-serif; background:#000; color:#fff; }
  video { width:100vw; height:100vh; object-fit:cover; display:block; }

  #status { position:fixed; top:0; left:0; right:0; z-index:10;
    background:rgba(0,0,0,.7); color:#fff; padding:8px 12px; font-size:14px; }

  #overlay { position:fixed; bottom:0; left:0; right:0; z-index:10;
    background:rgba(0,0,0,.85); color:var(--accent);
    padding:10px; font-size:15px; max-height:45%; overflow:auto; }

  #toolbar { position:fixed; top:44px; right:10px; z-index:11; display:flex; gap:8px; flex-wrap:wrap; }
  .btn { background:rgba(0,0,0,.6); color:#fff; border:1px solid var(--accent); border-radius:6px;
    padding:6px 10px; font-size:14px; cursor:pointer; }
  .btn:disabled { opacity:.5; cursor:not-allowed; }

  .roi { position:fixed; inset:0; pointer-events:none; z-index:5; }
  .roi::before{
    content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:60vw; height:30vh; border:2px dashed rgba(0,255,136,.9);
    box-shadow:0 0 0 9999px rgba(0,0,0,.35) inset, 0 0 12px rgba(0,255,136,.5);
    border-radius:8px;
  }
  .small{ color:#ccc; font-size:12px; }
</style>
</head>

<body>
  <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>

  <div id="toolbar">
    <button id="btnToggleTorch" class="btn" disabled>üî¶ ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏â‡∏≤‡∏¢</button>
    <button id="btnUnlock" class="btn" disabled>üîÅ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
  </div>

  <div class="roi" aria-hidden="true"></div>
  <video id="video" autoplay playsinline></video>
  <div id="overlay">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‚Ä¶</div>

  <audio id="ding" preload="auto">
    <source src="https://cdn.jsdelivr.net/gh/naptha/tesseract.js@master/docs/examples/data/confirm.mp3" type="audio/mpeg">
  </audio>

<script>
const video   = document.getElementById("video");
const overlay = document.getElementById("overlay");
const statusEl= document.getElementById("status");
const btnUnlock = document.getElementById("btnUnlock");
const btnToggleTorch = document.getElementById("btnToggleTorch");
const ding = document.getElementById("ding");

/* ===== 1) Google Sheet (CSV) ===== */
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpXuB-T6npWk7MYedMvVFZCNghCnMg9Iu79j0KcMVreOMhksr6pLmOGpdGwfftRzRUMJGnPtr0H4wP/pub?gid=0&single=true&output=csv";

/* ===== ‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏ï‡∏≤‡∏° "‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô" ===== */
const ASSETS_BASE = new Map(); // key: ‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô 8‚Äì9 ‡∏´‡∏•‡∏±‡∏Å, value: Array<HTML>

/* Utils */
function escapeHTML(str){return (str??"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}
function normalizeBase(str){const m=((str??"")+"").match(/\d{8,9}/);return m?m[0]:"";}

/* ===== 2) ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ï ===== */
async function loadSheet(){
  try{
    const res = await fetch(SHEET_URL,{cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const text = await res.text();

    const parsed = Papa.parse(text,{header:false,skipEmptyLines:true});
    for(let i=1;i<parsed.data.length;i++){
      const c = parsed.data[i];
      const codeFull = ((c[1]??"")+"").trim(); // ‡πÄ‡∏ä‡πà‡∏ô "510368809-0000"
      const base = normalizeBase(codeFull);     // -> "510368809"
      if(!base) continue;

      const html = `
        <b>‡∏£‡∏´‡∏±‡∏™:</b> ${escapeHTML(codeFull)}<br>
        <b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${escapeHTML((c[3]??"").toString().trim())}<br>
        <b>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠:</b> ${escapeHTML((c[5]??"").toString().trim())}<br>
        <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ú‡∏•‡∏¥‡∏ï:</b> ${escapeHTML((c[6]??"").toString().trim())}<br>
        <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤:</b> ${escapeHTML((c[7]??"").toString().trim())}<br>
        <b>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤:</b> ${escapeHTML((c[8]??"").toString().trim())} ‡∏ö‡∏≤‡∏ó<br>
        <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${escapeHTML((c[11]??"").toString().trim())}
      `;

      if(!ASSETS_BASE.has(base)) ASSETS_BASE.set(base,[]);
      ASSETS_BASE.get(base).push(html);
    }

    statusEl.innerText = `‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${ASSETS_BASE.size.toLocaleString()} ‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô`;
  }catch(e){
    console.error(e);
    statusEl.innerText = "‡πÇ‡∏´‡∏•‡∏î Google Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  }
}

/* ===== 3) ‡∏Å‡∏•‡πâ‡∏≠‡∏á & ‡πÑ‡∏ü‡∏â‡∏≤‡∏¢ ===== */
let track=null; let torchOn=false;
async function initCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:"environment"}, width:{ideal:1920}, height:{ideal:1080}},
      audio:false
    });
    video.srcObject = stream;
    track = stream.getVideoTracks()[0];
    statusEl.innerText = "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";

    try{
      const caps = track.getCapabilities?.()||{};
      if("torch" in caps){ btnToggleTorch.disabled=false; }
    }catch{}
  }catch(err){
    console.error(err);
    statusEl.innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + (err.message||err);
  }
}
btnToggleTorch.addEventListener("click", async()=>{
  if(!track) return;
  try{
    const caps = track.getCapabilities?.()||{};
    if(!("torch" in caps)) return;
    torchOn = !torchOn;
    await track.applyConstraints({advanced:[{torch:torchOn}]});
    btnToggleTorch.textContent = torchOn? "üî¶ ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏â‡∏≤‡∏¢":"üî¶ ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏â‡∏≤‡∏¢";
  }catch(e){ console.warn("Torch error:",e); }
});

/* ===== 4) Tesseract Worker ===== */
let worker, workerReady=false;
async function initOcr(){
  worker = await Tesseract.createWorker("eng",1,{logger:()=>{}});
  await worker.setParameters({tessedit_char_whitelist:"0123456789", classify_bln_numeric_mode:"1"});
  workerReady = true;
}

/* ===== 5) ‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ROI + debounce ===== */
let locked=false, lastRun=0;
const SCAN_INTERVAL_MS = 1200;

function getRoiCanvas(){
  const vw=video.videoWidth, vh=video.videoHeight;
  if(!vw||!vh) return null;
  const roiW=Math.floor(vw*0.60), roiH=Math.floor(vh*0.30);
  const roiX=Math.floor((vw-roiW)/2), roiY=Math.floor((vh-roiH)/2);

  const canvas=document.createElement("canvas");
  canvas.width=roiW; canvas.height=roiH;
  const ctx=canvas.getContext("2d");
  ctx.imageSmoothingEnabled=false;
  ctx.drawImage(video, roiX,roiY,roiW,roiH, 0,0,roiW,roiH);

  // grayscale + contrast
  const img=ctx.getImageData(0,0,roiW,roiH); const d=img.data;
  for(let i=0;i<d.length;i+=4){
    const gray=(d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114) | 0;
    const v=Math.max(0,Math.min(255,(gray-128)*1.2+128));
    d[i]=d[i+1]=d[i+2]=v;
  }
  ctx.putImageData(img,0,0);
  return canvas;
}

async function loopScan(){
  const now=Date.now();
  if(!workerReady||locked) return;
  if(now-lastRun<SCAN_INTERVAL_MS) return;
  if(video.readyState<2||video.videoWidth===0) return;

  lastRun=now;

  const canvas=getRoiCanvas();
  if(!canvas) return;

  try{
    const {data} = await worker.recognize(canvas);
    const raw=(data.text||"").replace(/\s+/g," ").trim();
    overlay.innerHTML = `OCR ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ:<br><span class="small">${escapeHTML(raw)}</span>`;

    const base = normalizeBase(raw);          // <<<< ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å OCR
    if(base){
      const items = ASSETS_BASE.get(base);    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏ô suffix
      if(items && items.length>0){
        locked=true;
        overlay.innerHTML = items.length===1
          ? `‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå<br><br>${items[0]}`
          : `‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô ${base}<br><br>${items.map(x=>`<div style="margin-bottom:10px">${x}</div>`).join("")}`;
        try{navigator.vibrate?.(120);}catch{}
        try{ding.currentTime=0; ding.play().catch(()=>{});}catch{}
        btnUnlock.disabled=false;
      }else{
        overlay.innerHTML = `‚ö†Ô∏è ‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ê‡∏≤‡∏ô ${base}<br>‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`;
      }
    }
  }catch(e){
    console.error("OCR error:",e);
  }
}
btnUnlock.addEventListener("click", ()=>{
  locked=false; btnUnlock.disabled=true; overlay.innerHTML="‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‚Ä¶";
});
setInterval(loopScan,200);

/* ===== Start ===== */
(async function main(){
  await loadSheet();
  await initCamera();
  await initOcr();
  statusEl.innerText += " ‚Ä¢ OCR ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
})();
</script>
</body>
</html>
``
