<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asset Camera Scanner</title>

<!-- Tesseract.js v5 -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<!-- PapaParse ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö parse CSV -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  body { margin:0; font-family: Arial, system-ui, sans-serif; background:#000; color:#fff; }
  video { width:100vw; height:100vh; object-fit:cover; display:block; }

  #status {
    position:fixed; top:0; left:0; right:0;
    background:rgba(0,0,0,.7); color:#fff;
    padding:8px 12px; font-size:14px; z-index:10;
  }

  #overlay {
    position:fixed; bottom:0; left:0; right:0;
    background:rgba(0,0,0,.85); color:#00ff88;
    padding:10px; font-size:15px; max-height:45%;
    overflow:auto; z-index:10;
  }

  #toolbar {
    position:fixed; top:40px; right:10px; z-index:11;
    display:flex; gap:8px; flex-wrap:wrap;
  }
  .btn {
    background:rgba(0,0,0,.6);
    color:#fff; border:1px solid #00ff88; border-radius:6px;
    padding:6px 10px; font-size:14px; cursor:pointer;
  }
  .btn:disabled { opacity:.5; cursor:not-allowed; }

  /* ROI (‡∏Å‡∏£‡∏≠‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡πá‡∏á) */
  .roi {
    position:fixed; inset:0; pointer-events:none; z-index:5;
  }
  .roi::before {
    content:"";
    position:absolute; left:50%; top:50%;
    transform:translate(-50%, -50%);
    width:60vw; height:30vh;            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ */
    border:2px dashed rgba(0,255,136,.9);
    box-shadow:
      0 0 0 9999px rgba(0,0,0,.35) inset, /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏ö‡∏ô‡∏≠‡∏Å‡∏°‡∏∑‡∏î‡∏•‡∏á */
      0 0 12px rgba(0,255,136,.5);
    border-radius:8px;
  }

  .small {
    color:#ccc; font-size:12px;
  }
</style>
</head>

<body>
  <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>
  <div id="toolbar">
    <button id="btnToggleTorch" class="btn" disabled>üî¶ ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏â‡∏≤‡∏¢</button>
    <button id="btnUnlock" class="btn" disabled>üîÅ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
  </div>
  <div class="roi" aria-hidden="true"></div>

  <video id="video" autoplay playsinline></video>
  <div id="overlay">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‚Ä¶</div>

  <!-- ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏¥‡πä‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏ö -->
  <audio id="ding" preload="auto">
    <source src="https://cdn.jsdelivr.net/gh/naptha/tesseract.js@master/docs/examples/data/confirm.mp3" type="audio/mpeg">
  </audio>

<script>
const video   = document.getElementById("video");
const overlay = document.getElementById("overlay");
const statusEl  = document.getElementById("status");
const btnUnlock = document.getElementById("btnUnlock");
const btnToggleTorch = document.getElementById("btnToggleTorch");
const ding = document.getElementById("ding");

/* ==============================
   1) Google Sheet (CSV)
   ============================== */
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQpXuB-T6npWk7MYedMvVFZCNghCnMg9Iu79j0KcMVreOMhksr6pLmOGpdGwfftRzRUMJGnPtr0H4wP/pub?gid=0&single=true&output=csv";

const ASSETS = new Map(); // ‡πÉ‡∏ä‡πâ Map ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô

/* ==============================
   2) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet (‡∏ó‡∏ô CSV ‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô)
   ============================== */
async function loadSheet() {
  try {
    const res = await fetch(SHEET_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();

    // PapaParse ‡∏à‡∏∞ handle ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î/‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤/‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á
    const parsed = Papa.parse(text, {
      header: false,
      skipEmptyLines: true
    });

    // ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (index 0)
    for (let i = 1; i < parsed.data.length; i++) {
      const c = parsed.data[i];

      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô index ‡πÑ‡∏°‡πà‡∏°‡∏µ
      const colB = ((c[1] ?? "") + "").trim(); // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B ‡πÄ‡∏ä‡πà‡∏ô 510452225-0000
      const short = colB.match(/\d{8,9}/)?.[0];
      if (!short) continue;

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏î‡πâ‡∏ß‡∏¢ ?? "-")
      const detail  = (c[3] ?? "-").toString().trim();
      const brand   = (c[5] ?? "-").toString().trim();
      const serial  = (c[6] ?? "-").toString().trim();
      const gotDate = (c[7] ?? "-").toString().trim();
      const price   = (c[8] ?? "-").toString().trim();
      const status  = (c[11] ?? "-").toString().trim();

      const html = `
        <b>‡∏£‡∏´‡∏±‡∏™:</b> ${escapeHTML(colB)}<br>
        <b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${escapeHTML(detail)}<br>
        <b>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠:</b> ${escapeHTML(brand)}<br>
        <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ú‡∏•‡∏¥‡∏ï:</b> ${escapeHTML(serial)}<br>
        <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤:</b> ${escapeHTML(gotDate)}<br>
        <b>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤:</b> ${escapeHTML(price)} ‡∏ö‡∏≤‡∏ó<br>
        <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${escapeHTML(status)}
      `;

      ASSETS.set(short, html);
    }

    statusEl.innerText = `‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${ASSETS.size.toLocaleString()} ‡∏ä‡∏¥‡πâ‡∏ô`;
  } catch (e) {
    console.error(e);
    statusEl.innerText = "‡πÇ‡∏´‡∏•‡∏î Google Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  }
}

/* ==============================
   3) ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á + (‡πÑ‡∏ü‡∏â‡∏≤‡∏¢ ‡∏ñ‡πâ‡∏≤‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
   ============================== */
let currentStream = null;
let track = null;
let imageCapture = null;
let torchOn = false;

async function initCamera() {
  try {
    const constraints = {
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      },
      audio: false
    };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    currentStream = stream;
    video.srcObject = stream;
    statusEl.innerText = "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";

    track = stream.getVideoTracks()[0];

    // ‡∏•‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á ImageCapture ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à Torch
    try {
      const trackSettings = track.getSettings?.() || {};
      const trackCapabilities = track.getCapabilities?.() || {};
      if ("torch" in trackCapabilities) {
        imageCapture = new ImageCapture(track);
        btnToggleTorch.disabled = false;
      }
    } catch {
      // ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏â‡∏≤‡∏¢
    }
  } catch (err) {
    console.error(err);
    statusEl.innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: " + (err.message || err);
  }
}

btnToggleTorch.addEventListener("click", async () => {
  if (!track) return;
  try {
    const caps = track.getCapabilities?.() || {};
    if (!("torch" in caps)) return;

    torchOn = !torchOn;
    await track.applyConstraints({ advanced: [{ torch: torchOn }] });
    btnToggleTorch.textContent = torchOn ? "üî¶ ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏â‡∏≤‡∏¢" : "üî¶ ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏â‡∏≤‡∏¢";
  } catch (e) {
    console.warn("Torch error:", e);
  }
});

/* ==============================
   4) ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Tesseract Worker
   ============================== */
let worker;
let workerReady = false;

async function initOcr() {
  worker = await Tesseract.createWorker("eng", 1, {
    logger: m => {
      // console.log(m);
    }
  });

  // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
  await worker.setParameters({
    tessedit_char_whitelist: "0123456789",
    classify_bln_numeric_mode: "1"
  });

  workerReady = true;
}

/* ==============================
   5) ‡∏ß‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ROI + debounce
   ============================== */
let locked = false;
let lastRun = 0;
const SCAN_INTERVAL_MS = 1200;

function getRoiCanvas() {
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á canvas ‡∏ï‡∏±‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏ã‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏û (60% x 30%) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
  const vw = video.videoWidth;
  const vh = video.videoHeight;
  if (!vw || !vh) return null;

  const roiW = Math.floor(vw * 0.60);
  const roiH = Math.floor(vh * 0.30);
  const roiX = Math.floor((vw - roiW) / 2);
  const roiY = Math.floor((vh - roiH) / 2);

  const canvas = document.createElement("canvas");
  canvas.width = roiW;
  canvas.height = roiH;

  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;

  // ‡∏ß‡∏≤‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ROI
  ctx.drawImage(video, roiX, roiY, roiW, roiH, 0, 0, roiW, roiH);

  // ‡∏ó‡∏≥ pre-process ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏£‡∏≤‡∏™‡∏ï‡πå/‡∏•‡∏î‡∏ô‡∏≠‡∏¢‡∏™‡πå (‡∏á‡πà‡∏≤‡∏¢‡πÜ)
  const imgData = ctx.getImageData(0, 0, roiW, roiH);
  const d = imgData.data;
  for (let i = 0; i < d.length; i += 4) {
    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô grayscale
    const gray = (d[i] * 0.299 + d[i+1] * 0.587 + d[i+2] * 0.114) | 0;
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏£‡∏≤‡∏™‡∏ï‡πå‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
    const contrasted = Math.max(0, Math.min(255, (gray - 128) * 1.2 + 128));
    const v = contrasted;
    d[i] = d[i+1] = d[i+2] = v;
    // alpha ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°
  }
  ctx.putImageData(imgData, 0, 0);

  return canvas;
}

async function loopScan() {
  const now = Date.now();
  if (!workerReady || locked) return;
  if (now - lastRun < SCAN_INTERVAL_MS) return;
  if (video.readyState < 2 || video.videoWidth === 0) return;

  lastRun = now;

  const canvas = getRoiCanvas();
  if (!canvas) return;

  try {
    const { data } = await worker.recognize(canvas);
    const raw = (data.text || "").replace(/\s+/g, " ").trim();

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° OCR ‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
    overlay.innerHTML = `OCR ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ:<br><span class="small">${escapeHTML(raw)}</span>`;

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô 8‚Äì9 ‡∏´‡∏•‡∏±‡∏Å
    const found = raw.match(/\d{8,9}/);
    if (found) {
      const code = found[0];

      if (ASSETS.has(code)) {
        locked = true;
        const html = ASSETS.get(code);
        overlay.innerHTML = `‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå<br><br>${html}`;

        // ‡∏™‡∏±‡πà‡∏ô + ‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        try { navigator.vibrate?.(120); } catch {}
        try { ding.currentTime = 0; ding.play().catch(()=>{}); } catch {}

        btnUnlock.disabled = false;
      } else {
        overlay.innerHTML = `‚ö†Ô∏è ‡∏û‡∏ö‡πÄ‡∏•‡∏Ç ${escapeHTML(code)}<br>‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`;
      }
    }
  } catch (e) {
    console.error("OCR error:", e);
  }
}

// ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà
btnUnlock.addEventListener("click", () => {
  locked = false;
  btnUnlock.disabled = true;
  overlay.innerHTML = "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‚Ä¶";
});

// ‡∏ß‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢ setInterval + guard time
setInterval(loopScan, 200);

/* ==============================
   Utils
   ============================== */
function escapeHTML(str) {
  return (str ?? "").toString()
    .replace(/&/g, "&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

/* ==============================
   ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
   ============================== */
(async function main() {
  await loadSheet();
  await initCamera();
  await initOcr();
  statusEl.innerText += " ‚Ä¢ OCR ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
})();
</script>

</body>
</html>
