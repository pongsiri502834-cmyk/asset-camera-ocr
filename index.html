<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Camera OCR</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body { margin:0; background:#000; font-family:Arial; }
video { width:100vw; height:100vh; object-fit:cover; }

#status {
  position:fixed; top:0; width:100%;
  background:rgba(0,0,0,.7);
  color:#fff; padding:6px 10px;
  font-size:14px;
}

#overlay {
  position:fixed; bottom:0; width:100%;
  background:rgba(0,0,0,.85);
  color:#00ff88; padding:12px;
  font-size:16px; max-height:45%;
  overflow:auto;
}
</style>
</head>

<body>

<div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>
<video id="video" autoplay playsinline></video>
<div id="overlay">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô OCR</div>

<script>
const video   = document.getElementById("video");
const overlay = document.getElementById("overlay");
const status  = document.getElementById("status");

/* ================= Google Sheet ================= */
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQpXuB-T6npWk7MYedMvVFZCNghCnMg9Iu79j0KcMVreOMhksr6pLmOGpdGwfftRzRUMJGnPtr0H4wP/pub?gid=0&single=true&output=csv";

let ASSETS = {};
let locked = false;

/* ================= ‡πÇ‡∏´‡∏•‡∏î Sheet ================= */
fetch(SHEET_URL)
.then(r => r.text())
.then(csv => {
  csv.split("\n").slice(1).forEach(r => {
    const c = r.split(",");
    const code = (c[1] || "").replace(/\D/g,""); // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B
    if (code.length >= 8) {
      ASSETS[code] = `
        <b>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå:</b> ${c[1]}<br>
        <b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${c[3] || "-"}<br>
        <b>‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠:</b> ${c[5] || "-"}<br>
        <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç:</b> ${c[6] || "-"}<br>
        <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤:</b> ${c[7] || "-"}<br>
        <b>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤:</b> ${c[8] || "-"} ‡∏ö‡∏≤‡∏ó<br>
        <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${c[11] || "-"}
      `;
    }
  });
  status.innerText = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‚Äì ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á";
});

/* ================= ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ================= */
navigator.mediaDevices.getUserMedia({
  video:{ facingMode:"environment" }
}).then(s=>{
  video.srcObject = s;
});

/* ================= OCR Loop ================= */
setInterval(async () => {
  if (locked || video.videoWidth === 0) return;

  const canvas = document.createElement("canvas");
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);

  const ocr = await Tesseract.recognize(canvas, "eng", {
    tessedit_char_whitelist: "0123456789",
    classify_bln_numeric_mode: 1
  });

  const rawText = ocr.data.text || "";

  // üî• ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 8 ‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ
  const matches = rawText.match(/\d{8,}/g) || [];

  overlay.innerHTML =
    "<b>OCR ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ:</b><br>" + rawText +
    "<br><br><b>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‚â•8):</b><br>" +
    (matches.join("<br>") || "-");

  for (const num of matches) {
    if (ASSETS[num]) {
      locked = true;
      overlay.innerHTML = "‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß<br><br>" + ASSETS[num];
      status.innerText = "‡∏•‡πá‡∏≠‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß";
      break;
    }
  }

}, 1500);
</script>

</body>
</html>
